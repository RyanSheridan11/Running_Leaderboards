<h1>Sign Up</h1>

<%= form_with model: @user, url: users_path, local: true do |form| %>
  <% if @user.errors.any? %>
    <div class="errors">
      <ul>
        <% @user.errors.full_messages.each do |msg| %>
          <li><%= msg %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div>
    <%= form.label :firstname, "First Name" %><br>
    <%= form.text_field :firstname, required: true, id: "user_firstname" %>
  </div>
  <div>
    <%= form.label :lastname, "Last Name" %><br>
    <%= form.text_field :lastname, required: true, id: "user_lastname" %>
  </div>
  <div>
    <%= form.label :username, "Username (auto-generated)" %><br>
    <%= form.text_field :username, readonly: true, id: "user_username", placeholder: "Will be generated automatically", style: "background-color: #f8f9fa; color: #6c757d;" %>
  </div>
  <div>
    <%= form.label :strava_username, "Strava Username (optional)" %><br>
    <%= form.text_field :strava_username, placeholder: "Your Strava username" %>
  </div>
  <div>
    <%= form.label :password %><br>
    <%= form.password_field :password %>
  </div>
  <div>
    <%= form.label :password_confirmation %><br>
    <%= form.password_field :password_confirmation %>
  </div>
  <div>
    <%= form.submit "Sign Up" %>
  </div>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const firstnameField = document.getElementById('user_firstname');
  const lastnameField = document.getElementById('user_lastname');
  const usernameField = document.getElementById('user_username');

  function generateUsername() {
    const firstname = firstnameField.value.trim();
    const lastname = lastnameField.value.trim();

    if (firstname && lastname) {
      // Remove special characters and convert to lowercase
      const cleanFirstname = firstname.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();
      const cleanLastname = lastname.replace(/[^a-zA-Z0-9]/g, '').toLowerCase();

      if (cleanFirstname && cleanLastname) {
        const username = cleanFirstname + cleanLastname.charAt(0);
        usernameField.value = username;
        usernameField.style.color = '#333';
      } else {
        usernameField.value = '';
        usernameField.style.color = '#6c757d';
      }
    } else {
      usernameField.value = '';
      usernameField.style.color = '#6c757d';
    }
  }

  // Generate username when either name field changes
  firstnameField.addEventListener('input', generateUsername);
  lastnameField.addEventListener('input', generateUsername);

  // Generate initial username if fields are pre-filled
  generateUsername();
});</script>

<p>Already have an account? <%= link_to "Log in", login_path %></p>
